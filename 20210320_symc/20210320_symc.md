# C ソースをパースしてシンボルを抽出する Go ライブラリ symc を作った

C ソースをパースして変数, 関数の定義や使用箇所を抽出する Go ライブラリを作成した.

[symc][1]

## 作った背景

普段 C ソースを相手に仕事をしてるが, ソースを静的に解析する機会など多い.

ソース内にある識別子がどこで定義されどこで使用されるかなどの情報がそういった解析時に欲しくなる時がある.

ソースを解析して識別子情報だけを手軽に抽出するライブラリを作成すれば, 応用して色々なツールが作れるのではないかと考えた.

ツール類は Go で作成する機会が多いため, Go ライブラリとして作成.


## 機能

主な機能は以下.

* プリプロ展開後の C ソースを入力とする
    * プリプロ解析からやるのは環境による差異など色々困難なため妥協
    * プリプロ展開していないソースを入力した場合, エラーで死にます
* 解析したモジュールに対して以下の情報を抽出する
    * 定義している変数
    * 定義している関数
    * extern 宣言している変数
    * プロトタイプ宣言している関数
    * 関数内で参照している変数
    * 関数内でコールしている関数の情報

## 使い方

使い方は以下のとおり.

```go
package main

import (
	"fmt"

	"github.com/kita127/symc"
)

func main() {

	cSrc := `
int variable;

int extFunc( int a );

int func( void ){

    variable++;

    return extFunc( variable );
}

`

	module := symc.ParseModule(string(cSrc))
	fmt.Println(module)
}
```

    >go build && ./main
    Module : Symbols={ VariableDef : Name=variable, PrototypeDecl : Name=extFunc, FunctionDef : Name=func, Params=[], Symbols=[Assigne : Name=variable CallFunc : Name=extFunc, Args=[RefVar : Name=variable]] }


`github.com/kita127/symc` をインポートして, `symc.ParseModule()` に C ソースの文字列を渡せば,
そのソースの識別子情報構造体を返してくれる.

上記では C ソース解析後, そのソースの情報を `symc.Module` 構造体のポインタを取得している.

取得した `symc.Module` 構造体のポインタは 変数の定義`VariableDef` や関数の定義`FunctionDef` 情報などを保持してる.

関数の定義情報の中にはその関数内で参照している変数などの情報も取得できる.

<br>

解析した情報を少し見やすくする Pretty string 機能もある.

```go
package main

import (
	"fmt"
	"io/ioutil"
	"os"

	"github.com/kita127/symc"
)

	cSrc := `
int variable;

int extFunc( int a );

int func( void ){

    variable++;

    return extFunc( variable );
}

`


func main() {
	module := symc.ParseModule(string(cSrc))
	fmt.Println(module.PrettyString())
}
```

    >go build && ./main
    DEFINITION variable
    PROTOTYPE extFunc
    FUNC func() {
        ASSIGNE variable
        extFunc(variable)
    }

## 注意点

Mac の gcc(ホントは clang?) でしか確認していないため他のコンパイラツールチェーンでプリプロ展開したソースはダメかもしれない.

モダンな C 言語の構文には対応していない. 多分, C90 くらいまでの構文はいけると思う(適当)

当然ながら個人作成の雑雑ライブラリなので, まじめな用途には使わないでください.

もし, 使用する場合はちょっと構文解析結果がミスしていても大目に見れる範疇でお願いします.


## 反省点とその他

ライブラリ作成途中に goyacc という Go 用のパーサジェネレータの存在を知った.

本来であればこういった構文解析系のライブラリは既存のパーサジェネレータ等を使うべきだが,
かなり作ってから知ったのでそのまま作り切った.  (ちなみに自前で字句解析・構文解析している)

一応, ユニットテストをこまめに作りながら作成を進めたので大体いけているとは思う.


[1]:https://github.com/kita127/symc
